

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scripts.DatabankLib.form_factor &mdash; NMRlipids databank 4.9.2023 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=10ee5b61"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            NMRlipids databank
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User information:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../listOfFiles.html">List and descriptions of NMRlipids databank files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../READMEcontent.html">User input and content of README.yaml files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../addingData.html">Adding simulations into the NMRlipids databank</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../addingExpData.html">Adding experimental data into the NMRlipids databank</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../moleculesAndMapping.html">Universal molecule and atom names</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../databankLibrary.html">NMRlipids databank API functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../exampleAndTutorials.html">Examples and tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Structure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Overview.html">Project structure</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NMRlipids databank</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">Scripts.DatabankLib.form_factor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for Scripts.DatabankLib.form_factor</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module form_factor serves for bilayer form factor calculations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">MDAnalysis</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mda</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># for testing purposes to safe time for loading trajectory and creating dictonary</span>
<span class="c1"># the electron.dat will be decripted in the future as the values will be used from</span>
<span class="c1"># the universal mapping file</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">periodictable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.databankLibrary</span><span class="w"> </span><span class="kn">import</span> <span class="n">lipids_set</span><span class="p">,</span> <span class="n">getLipids</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.jsonEncoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompactJSONEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib</span><span class="w"> </span><span class="kn">import</span> <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">NMLDB_DATA_PATH</span>


<span class="c1"># To write data in numpy arrays into json file, we inherit compact JSON</span>
<span class="c1"># encoder to make him store 2xN numpy arrays as just a nested list</span>
<div class="viewcode-block" id="NumpyArrayEncoder">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.NumpyArrayEncoder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NumpyArrayEncoder</span><span class="p">(</span><span class="n">CompactJSONEncoder</span><span class="p">):</span>
<div class="viewcode-block" id="NumpyArrayEncoder.encode">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.NumpyArrayEncoder.encode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CompactJSONEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CompactJSONEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="FormFactor">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FormFactor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates form factors from density profiles.</span>

<span class="sd">    Further development will include thickness of the membrane</span>
<span class="sd">    from the intersection of lipid density and water density.</span>
<span class="sd">    Already enables to calculate electrom/mass/number densities</span>

<span class="sd">    Density could be calculated only from the final form factor profile</span>
<span class="sd">    - testing is needed to see stability for rare species.</span>

<span class="sd">    Examination of FF error spikes is needed!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Group of static private helper methods</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__list_name_pairs</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">molecule</span><span class="p">):</span>
        <span class="n">pairs_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span><span class="p">[</span><span class="s1">&#39;RESIDUE&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;RESIDUE&#39;</span> <span class="ow">in</span> <span class="n">mv</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">residues</span><span class="p">:</span>
            <span class="n">pairs_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pairs_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pairs_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pairs_dictionary</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">mk</span><span class="p">,</span> <span class="n">mv</span><span class="p">[</span><span class="s1">&#39;ATOMNAME&#39;</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">mk</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">mv</span><span class="p">[</span><span class="s1">&#39;RESIDUE&#39;</span><span class="p">]</span>
                    <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pairs_dictionary</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">molecule</span><span class="p">:</span> <span class="p">[[</span><span class="n">mn</span><span class="p">,</span> <span class="n">mv</span><span class="p">[</span><span class="s1">&#39;ATOMNAME&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">pairs_dictionary</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__filter_hbonds</span><span class="p">(</span><span class="n">mapping_names</span><span class="p">):</span>
        <span class="n">re_h</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;M_([A-Z]{1,2}[0-9]{1,4})*H[0-4]{1,2}_M&#39;</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">re_h</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">mapping_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filtered</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__get_water</span><span class="p">(</span><span class="n">rmf</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;resname &#39;</span> <span class="o">+</span> <span class="n">rmf</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="s1">&#39;SOL&#39;</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">])</span>

    <span class="c1"># -- regular methods --</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span>
                 <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span> <span class="n">density_type</span><span class="o">=</span><span class="s2">&quot;electron&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gro&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="c1"># assume conf was TPR</span>
            <span class="n">gro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;conf.gro&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating conf.gro because MDAnalysis cannot read tpr version&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo System | gmx trjconv &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;-s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="si">}</span><span class="s2"> -f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="si">}</span><span class="s2"> -dump 0 -o </span><span class="si">{</span><span class="n">gro</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">gro</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading the trajectory takes </span><span class="si">{:10.6f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span>

        <span class="c1"># number of bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span> <span class="o">=</span> <span class="n">nbin</span>
        <span class="c1"># the totatl box size in [nm] - will be probably removed and tpr box size or</span>
        <span class="c1"># transform of final FF will be used instead</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipids</span> <span class="o">=</span> <span class="n">getLipids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waters</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">__get_water</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">density_type</span> <span class="o">=</span> <span class="n">density_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weight</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_density</span><span class="p">()</span>

<div class="viewcode-block" id="FormFactor.get_electrons">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.get_electrons">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_electrons</span><span class="p">(</span><span class="n">mapping_name</span><span class="p">):</span>
        <span class="c1"># removes numbers and &#39;_M&#39; from the end of string</span>
        <span class="n">name1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9]*_M$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mapping_name</span><span class="p">)</span>
        <span class="c1"># removes M_X12Y23... sequence from the beginning</span>
        <span class="n">name2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^M_([A-Z]{1,2}[0-9]{1,4})*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name1</span><span class="p">)</span>

        <span class="c1"># name2 is the atom and electrons are assigned to this atom</span>

        <span class="k">if</span> <span class="n">name2</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>  <span class="c1"># G is a glycerol carbon so change G to C</span>
            <span class="n">name2</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">periodictable</span><span class="p">,</span> <span class="n">name2</span><span class="p">)</span><span class="o">.</span><span class="n">number</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR: This mapping name cannot be read by our rules: </span><span class="si">{</span><span class="n">mapping_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consider changing naming in your mapping file.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># TODO Modify default charge modification</span>
        <span class="k">if</span> <span class="n">name2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">]:</span>
            <span class="n">el</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">name2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]:</span>
            <span class="n">el</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">#</span>

        <span class="c1"># TODO REMOVE WEIRD HERITAGE!!!</span>
        <span class="k">if</span> <span class="n">name2</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># WEIRD HERITAGE!!!</span>

        <span class="k">return</span> <span class="n">el</span></div>


<div class="viewcode-block" id="FormFactor.residue_electrons_all">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.residue_electrons_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">residue_electrons_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of electrons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathering electron list for </span><span class="si">{</span><span class="n">molecule</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">electrons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get the name of molecule used in simulation files</span>
        <span class="n">molname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="n">molecule</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>

        <span class="n">pairs_residue</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">__list_name_pairs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">molname</span><span class="p">)</span>

        <span class="c1"># if lipid is split to multiple residues</span>
        <span class="n">selection_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">selection_txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;moltype &quot;</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="n">molecule</span><span class="p">][</span><span class="s1">&#39;MOLTYPE&#39;</span><span class="p">]</span> <span class="o">+</span>
                <span class="s2">&quot; and &quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pairs_residue</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># fix second res in explicit_atoms</span>
            <span class="c1"># TODO: REPLACE THIS ENTIRE CODE WITH MDANALYSIS</span>
            <span class="c1"># when lipids are split into more than one residue in topology with</span>
            <span class="c1"># same residue names e.g. PGR,PA,OL and PE, PA,OL then</span>
            <span class="c1"># `u.select_atoms(&quot;resname &quot; + res)` does not distinguish</span>
            <span class="c1"># which PA or PL belongs to POPG or POPE</span>
            <span class="n">selection_txt</span> <span class="o">=</span> <span class="n">selection_txt</span> <span class="o">+</span> <span class="s2">&quot;resname &quot;</span> <span class="o">+</span> <span class="n">res</span>
            <span class="c1"># explicit atoms of the residue</span>
            <span class="n">explicit_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="n">selection_txt</span><span class="p">)</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">explicit_atoms</span><span class="p">:</span>
                <span class="c1"># find generic mapping name matching to forcefield atom name</span>
                <span class="n">atom_i1</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs_residue</span><span class="p">[</span><span class="n">res</span><span class="p">])):</span>
                    <span class="n">_cm</span> <span class="o">=</span> <span class="n">pairs_residue</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># [UNIQUE_NAME, NAME] pair</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">_cm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">+&#39;</span><span class="p">),</span> <span class="n">atom</span><span class="p">):</span>
                        <span class="n">atom_i1</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">atom_i1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom was not found: </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># # find mapping name</span>
                <span class="c1"># index_list = [atom in pairs for pairs in pairs_residue[res]]</span>
                <span class="c1"># print (atom, pairs_residue[res])</span>
                <span class="c1"># atom_i1 = index_list.index(True)</span>

                <span class="n">mapping_name</span> <span class="o">=</span> <span class="n">pairs_residue</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">atom_i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># get number of electrons in an atom i of residue</span>
                <span class="n">e_atom_i</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">get_electrons</span><span class="p">(</span><span class="n">mapping_name</span><span class="p">)</span>
                <span class="n">electrons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_atom_i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">electrons</span></div>


<div class="viewcode-block" id="FormFactor.assign_electrons">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.assign_electrons">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_electrons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check if simulation is united atom or all atom</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ua_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;UNITEDATOM_DICT&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">ua_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ua_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">l_weights</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># separate list for lipid electrons</span>
        <span class="n">w_weights</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># separate list for water electrons</span>

        <span class="k">if</span> <span class="n">ua_flag</span><span class="p">:</span>  <span class="c1"># UNITED ATOM SIMULATIONS</span>
            <span class="k">for</span> <span class="n">molecule1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">molecule1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">molecule1</span> <span class="ow">in</span> <span class="n">lipids_set</span><span class="p">:</span>
                    <span class="n">molecule2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="n">molecule1</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>
                    <span class="n">electrons</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">pairs_residue</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">__list_name_pairs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">molecule2</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">molecule2</span><span class="p">)</span>
                    <span class="n">h_atoms</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">__filter_hbonds</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">molecule2</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="c1"># list of hydrogen atoms</span>

                    <span class="c1"># extract explicit atoms and get the mapping names</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pairs_residue</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># explicit atoms of the residue</span>
                        <span class="n">explicit_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span>
                            <span class="s2">&quot;resname &quot;</span> <span class="o">+</span> <span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">explicit_atoms</span><span class="p">:</span>
                            <span class="c1"># print(atom)</span>
                            <span class="c1"># find generic mapping name matching to forcefield atom name</span>
                            <span class="n">index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">pairs_residue</span><span class="p">[</span><span class="n">res</span><span class="p">]]</span>
                            <span class="n">atom_i1</span> <span class="o">=</span> <span class="n">index_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">mapping_name</span> <span class="o">=</span> <span class="n">pairs_residue</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">atom_i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># remove _M from the end of mapping name</span>
                            <span class="n">name1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_M&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mapping_name</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span>

                            <span class="c1"># count how many times name1 occurs in atomsH i.e. how</span>
                            <span class="c1"># many H are bound to it</span>
                            <span class="n">h_num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                                <span class="mi">1</span> <span class="k">for</span> <span class="n">h_atm</span> <span class="ow">in</span> <span class="n">h_atoms</span>
                                <span class="k">if</span> <span class="n">name1</span> <span class="o">==</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;H[1-4]_M&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">h_atm</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span>
                                <span class="p">)</span>
                            <span class="n">number_e</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">get_electrons</span><span class="p">(</span><span class="n">mapping_name</span><span class="p">)</span>
                            <span class="n">e_atom_i</span> <span class="o">=</span> <span class="n">number_e</span> <span class="o">+</span> <span class="n">h_num</span>
                            <span class="n">electrons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_atom_i</span><span class="p">)</span>

                    <span class="n">weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">electrons</span><span class="p">)</span>
                    <span class="n">l_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">electrons</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_electrons_all</span><span class="p">(</span><span class="n">molecule1</span><span class="p">)</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">molecule1</span> <span class="o">==</span> <span class="s1">&#39;SOL&#39;</span><span class="p">:</span>
                        <span class="n">w_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ALL ATOM SIMULATIONS</span>
            <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_electrons_all</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
                <span class="n">weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">lipids_set</span><span class="p">:</span>
                    <span class="n">l_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">molecule</span> <span class="o">==</span> <span class="s1">&#39;SOL&#39;</span><span class="p">:</span>
                    <span class="n">w_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="c1"># how to do lipids split into three residues??    MAYBE WORKS</span>

        <span class="k">return</span> <span class="n">weights</span><span class="p">,</span> <span class="n">l_weights</span><span class="p">,</span> <span class="n">w_weights</span></div>


<div class="viewcode-block" id="FormFactor.calculate_weight">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.calculate_weight">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an array of weights for all atoms in the simulation.</span>

<span class="sd">        For electron densities:</span>
<span class="sd">         - creates dictonary of atom types and number of electrons</span>
<span class="sd">           loaded form an external file --&gt; in the future it backmaps</span>
<span class="sd">                                            the atom names to mapping files</span>
<span class="sd">                                            and automaticaly assigns # of electrons</span>

<span class="sd">        Number densities:</span>
<span class="sd">         - all weights are 1</span>

<span class="sd">        Mass densities:</span>
<span class="sd">         - reads masses from u.atoms.masses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_type</span> <span class="o">==</span> <span class="s2">&quot;electron&quot;</span><span class="p">:</span>
            <span class="c1"># calc weights to calculate the electron density</span>
            <span class="c1"># with the function that maps the electrons to atoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wght</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_wght</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_electrons</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lenght of wght: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wght</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lenght of lipid_wght: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;atoms in system: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wght</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Number of atoms mismatch&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: If lipids are split to many residues add moltype &quot;</span>
                      <span class="s2">&quot;of lipids from tpr as &#39;MOLTYPE&#39; to README.yaml &quot;</span>
                      <span class="s2">&quot;under &#39;COMPOSITION&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_type</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">clipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clipids</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cwaters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cwaters</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_type</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wght</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">masses</span>
            <span class="n">clipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">clipids</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cwaters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipid_wght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cwaters</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating the electron mapping dictonary takes </span><span class="si">{:10.6f}</span><span class="s2"> s&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span></div>


<div class="viewcode-block" id="FormFactor.calculate_density">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.calculate_density">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># TODO: remove excessive debug printing!</span>

        <span class="n">box_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># + 10 if fails</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">box_z</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">10</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span>  <span class="c1"># bin width</span>
        <span class="n">box_h</span> <span class="o">=</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">10</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">box_h</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">density_z_centered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">density_z_no_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">density_lipids_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">density_waters_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>

        <span class="c1"># Calculte density profiles and FF from individual frames</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">min_z</span> <span class="o">=</span> <span class="mi">10000000</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">elnum_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ua_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;UNITEDATOM_DICT&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">ua_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;UNITEDATOM_DICT&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ua_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ua_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">key1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pdbname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="n">key1</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pdbname</span><span class="p">)</span>
            <span class="n">mdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span>
            <span class="k">for</span> <span class="n">univ_aname</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">:</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="n">mdict</span><span class="p">[</span><span class="n">univ_aname</span><span class="p">][</span><span class="s1">&#39;ATOMNAME&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resname</span> <span class="o">=</span> <span class="n">mdict</span><span class="p">[</span><span class="n">univ_aname</span><span class="p">][</span><span class="s1">&#39;RESIDUE&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">resname</span> <span class="o">=</span> <span class="n">pdbname</span>

                <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elnum_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">elnum_dict</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">ua_flag</span> <span class="ow">and</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">lipids_set</span><span class="p">:</span>
                    <span class="n">ua_lip_json_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">NMLDB_DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;lipid_json_buildH&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;UNITEDATOM_DICT&#39;</span><span class="p">][</span><span class="n">key1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ua_lip_json_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                        <span class="n">ua_lip_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

                    <span class="n">h_num</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ua_lip_json</span><span class="p">[</span><span class="n">aname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CH&quot;</span><span class="p">:</span>
                            <span class="n">h_num</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">ua_lip_json</span><span class="p">[</span><span class="n">aname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CH2&quot;</span><span class="p">:</span>
                            <span class="n">h_num</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">if</span> <span class="n">ua_lip_json</span><span class="p">[</span><span class="n">aname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CH3&quot;</span><span class="p">:</span>
                            <span class="n">h_num</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="k">pass</span>

                    <span class="n">elnum_dict</span><span class="p">[</span><span class="n">resname</span><span class="p">][</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">FormFactor</span><span class="o">.</span><span class="n">get_electrons</span><span class="p">(</span><span class="n">univ_aname</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_num</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elnum_dict</span><span class="p">[</span><span class="n">resname</span><span class="p">][</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="n">FormFactor</span><span class="o">.</span><span class="n">get_electrons</span><span class="p">(</span><span class="n">univ_aname</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ElectronNumbers dictionary: &quot;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">elnum_dict</span><span class="p">)</span>

        <span class="c1"># define selections and dictionaries for profile calculations</span>
        <span class="n">clipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="p">)</span>
        <span class="n">cwaters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waters</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating final electron arrays from frame #1..&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">weights_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rname</span><span class="p">,</span> <span class="n">aname2enum</span> <span class="ow">in</span> <span class="n">elnum_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">enum</span> <span class="ow">in</span> <span class="n">aname2enum</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># all</span>
                <span class="n">csel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resname </span><span class="si">{</span><span class="n">rname</span><span class="si">}</span><span class="s2"> and name </span><span class="si">{</span><span class="n">aname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">weights_all</span><span class="p">[[</span><span class="n">_a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">csel</span><span class="p">]]</span> <span class="o">=</span> <span class="n">enum</span>

        <span class="n">weights_lipids</span> <span class="o">=</span> <span class="n">weights_all</span><span class="p">[[</span><span class="n">_a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">clipids</span><span class="p">]]</span>
        <span class="n">weights_waters</span> <span class="o">=</span> <span class="n">weights_all</span><span class="p">[[</span><span class="n">_a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">cwaters</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Iterating over trajectory&quot;</span><span class="p">):</span>
            <span class="c1"># count the index of the frame, numbered from 0, used to be used for the</span>
            <span class="c1"># density profile averaging</span>
            <span class="c1"># -- posible not needed now</span>
            <span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># ts.frame</span>

            <span class="c1"># reads the dimension in z-direction</span>
            <span class="n">box_z</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">10</span> <span class="o">&lt;</span> <span class="n">min_z</span><span class="p">:</span>
                <span class="n">min_z</span> <span class="o">=</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">10</span>

            <span class="c1"># reads the coordinates of all of the atoms</span>
            <span class="n">crds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span>

            <span class="n">crds_no_center</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span>

            <span class="c1"># calculates the center of mass of the selected atoms that the density</span>
            <span class="c1"># should be centered around and takes the z-coordinate value</span>
            <span class="n">ctom</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># moves the center of mass of the selected centering group into box/2</span>
            <span class="n">crds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ctom</span>

            <span class="c1"># shifts the coordinates in the universe by the value of</span>
            <span class="c1"># the center of mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">crds</span>

            <span class="c1"># puts the atoms back to the original box dimension; it possibly does not</span>
            <span class="c1"># take PBC into account, therefore it may brake some of the water molecules;</span>
            <span class="c1"># -- try it, come to the issue later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pack_into_box</span><span class="p">()</span>

            <span class="c1"># shif the coordinates so that the center in z-dimention is in 0;</span>
            <span class="c1"># divide by 10 to get the coordinates in nm, since now the crds are</span>
            <span class="c1"># only the z coordinates</span>
            <span class="n">crds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
            <span class="n">clipids_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">clipids</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
            <span class="n">cwaters_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">cwaters</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>

            <span class="c1"># calculates the volume of the bin; d- the &quot;height&quot; of a bin;</span>
            <span class="c1"># assumes in [nm]</span>
            <span class="c1"># ts.dimension[0], ts.dimension[1] - the x and y dimension;</span>
            <span class="c1"># in [A] --&gt; devides by 100</span>
            <span class="n">vbin</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">100</span>  <span class="c1"># needed for density, correct!</span>

            <span class="c1"># calculates the total density profile; keep for now</span>
            <span class="n">density_z_centered</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">crds</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights_all</span> <span class="o">/</span> <span class="n">vbin</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">density_z_no_center</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">crds_no_center</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">box_h</span><span class="p">),</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights_lipids</span> <span class="o">/</span> <span class="n">vbin</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># ELECTRON WEIGHTS</span>
            <span class="n">density_lipids_center</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">clipids_center</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights_lipids</span> <span class="o">/</span> <span class="n">vbin</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># ELECTRON WEIGHTS</span>
            <span class="n">density_waters_center</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">cwaters_center</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">box_h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights_waters</span> <span class="o">/</span> <span class="n">vbin</span><span class="p">,</span>
            <span class="p">)[</span>
                <span class="mi">0</span>
            <span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating the density takes </span><span class="si">{:10.6f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot; Normalizing the profiles &quot;&quot;&quot;</span>
        <span class="n">density_z_centered</span> <span class="o">/=</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">density_z_no_center</span> <span class="o">/=</span> <span class="n">frame</span>
        <span class="n">density_lipids_center</span> <span class="o">/=</span> <span class="n">frame</span>
        <span class="n">density_waters_center</span> <span class="o">/=</span> <span class="n">frame</span>

        <span class="c1"># Post-processign data and writing to file</span>
        <span class="n">density_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">density_z_centered</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">density_data_no_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">density_z_no_center</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">density_lipids_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">density_lipids_center</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">density_waters_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">density_waters_center</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># Get the indexes of the final density data where all the time steps contribute</span>
        <span class="c1"># In other words, take the coordinates of the smalest box from the simulation</span>
        <span class="n">final_ff_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">min_z</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">final_ff_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">min_z</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">ff_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">fa_aver</span><span class="p">,</span> <span class="n">fb_aver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourier</span><span class="p">(</span>
            <span class="n">density_data</span><span class="p">[</span><span class="n">final_ff_start</span><span class="p">:</span><span class="n">final_ff_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">density_data</span><span class="p">[</span><span class="n">final_ff_end</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">density_data</span><span class="p">[</span><span class="n">final_ff_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">ff_range</span><span class="p">,</span>
            <span class="n">density_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">density_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Plot density profiles from the average density with minimal box</span>
        <span class="n">fourrier_result2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">fa_aver</span><span class="p">,</span> <span class="n">fa_aver</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">fb_aver</span><span class="p">,</span> <span class="n">fb_aver</span><span class="p">))</span>
        <span class="n">fourrier_data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ff_range</span><span class="o">*</span><span class="mf">0.1</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">fourrier_result2</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># Save data into files</span>
        <span class="c1"># minimum box size density</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;TotalDensity.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">density_data</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;LipidDensity_no_center.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">density_data_no_center</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;LipidDensity.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">density_lipids_center</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;WaterDensity.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">density_waters_center</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                       <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># this is the important file form factors</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;FormFactor.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fourrier_data2</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%8.4f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write outputs in JSON</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;TotalDensity.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">density_data</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                      <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyArrayEncoder</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;LipidDensity.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">density_lipids_center</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                      <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyArrayEncoder</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;WaterDensity.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">density_waters_center</span><span class="p">[</span><span class="n">final_ff_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">final_ff_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                      <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyArrayEncoder</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;FormFactor.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fourrier_data2</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyArrayEncoder</span><span class="p">)</span></div>

    <span class="c1"># end calculate_density</span>

<div class="viewcode-block" id="FormFactor.fourier">
<a class="viewcode-back" href="../../../auto_gen/Scripts.DatabankLib.form_factor.html#Scripts.DatabankLib.form_factor.FormFactor.fourier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff_density</span><span class="p">,</span> <span class="n">box_z</span><span class="p">,</span> <span class="n">ff_range</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates fourier transform of ff_density in the FF_range.</span>
<span class="sd">        It calculates a &quot;height&quot; of a bin for FF puroposes; in this case the number of</span>
<span class="sd">        bins is constant and the bin width changes.</span>

<span class="sd">        Args:</span>
<span class="sd">            ff_density (_type_): TODO: fill</span>
<span class="sd">            box_z (_type_): TODO: fill</span>
<span class="sd">            ff_range (_type_): TODO: fill</span>
<span class="sd">            d_ff (_type_): TODO: fill</span>

<span class="sd">        Returns:</span>
<span class="sd">            _type_: TODO: fill</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Creates the direct space coordinates</span>
        <span class="c1"># the calculations are stable with rounding (and others) errors in the direct</span>
        <span class="c1"># space coordinates</span>
        <span class="n">ff_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ff_density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>\
            <span class="n">box_z</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">ff_density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bulk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">k</span><span class="o">*</span><span class="n">d_ff</span> <span class="o">&lt;</span> <span class="mf">0.33</span><span class="p">:</span>
            <span class="n">bulk</span> <span class="o">+=</span> <span class="n">ff_density</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">ff_density</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">bulk</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>

        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ff_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ff_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ff_density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fa</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ff_density</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">bulk</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ff_range</span><span class="o">*</span><span class="n">ff_x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span><span class="o">*</span><span class="n">d_ff</span>
            <span class="n">fb</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ff_density</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">bulk</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ff_range</span><span class="o">*</span><span class="n">ff_x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span><span class="o">*</span><span class="n">d_ff</span>

        <span class="k">return</span> <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NMRlipids open collaboration 
    OSI Approved: GNU General Public License v3 (GPLv3)
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version
   .
        <p>
            <a href="https://github.com/NMRLipids/Databank/blob/main/LICENSE.txt"
            target="_blank"
            rel="noopener">
            Link to GNU GPL v3 License
            </a>
        </p>
        <p>
            <a href="https://github.com/NMRLipids/Databank"
            target="_blank"
            rel="noopener">
            Link to the GitHub repository
            </a>
        </p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>